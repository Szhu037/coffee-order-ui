<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name = "viewport" content = "width=device-width, initial-scale=1.0">
    <title>Coffee Order System</title>
    <style>
        .container {
            display: flex;
            justify-content: center;
            align-items:center;
            height: 100vh;
        }
        .buttons {
            display: flex;
            flex-direction: column;
        }
        .cart {
            border: 1px solid #ccc;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<div id="page-start" class="container">
    <button onclick="showBeverageOptions()">Start your order here</button>
</div>
<script src="configuration.js"></script>

<div id="page-beverage" class="container" style="display: none;">
    <div class="buttons">
        <button onclick="selectBeverage('Dark roast')">Dark roast</button>
        <button onclick="selectBeverage('Espresso')">Espresso</button>
        <button onclick="selectBeverage('House blend')">House blend</button>
        <button onclick="selectBeverage('Decaf')">Decaf </button>
    </div>
    <div class="cart" id="cart"></div>
</div>

<div id="page-condiments" class="container" style="display: none;">
    <div class="buttons">
        <button onclick="addCondiment('Milk')">Milk</button>
        <button onclick="addCondiment('Mocha')">Mocha</button>
        <button onclick="addCondiment('Soy')">Soy</button>
        <button onclick="addCondiment('Whip')">Whip</button>
    </div>
    <div class="cart" id="cart-condiments"></div>
        <button onclick="goBackToBeverages()">Back to Beverages</button>
        <button onclick="confirmOrder()">Confirm Order</button>
</div>

<div id="page-confirmation" class="container" style="display: none;">
    <p id = "order-summary"></p>
</div>
<script>
    let host = "http://localhost:8080"
    let selectedBeverage = "";
    let selectedCondiments = [];

    function showBeverageOptions() {
        document.getElementById('page-start').style.display = 'none';
        document.getElementById('page-beverage').style.display = 'block';
    }
    function selectBeverage(beverage) {
        selectedBeverage = beverage;
        document.getElementById('page-beverage').style.display = 'none';
        document.getElementById('page-condiments').style.display = 'block';
    }
    function addCondiment(condiment) {
        selectedCondiments.push(condiment);
        renderCondiments();
    }
    function removeCondiment(index) {
        selectedCondiments.splice(index, 1);
        renderCondiments();
    }
    function goBackToBeverages() {
        selectedBeverage = "";
        selectedCondiments = [];
        document.getElementById('page-beverage').style.display = 'block';
        document.getElementById('page-condiments').style.display = 'none';
    }
    function renderCondiments() {
        const cartCondiments = document.getElementById('cart-condiments');
        cartCondiments.innerHTML = '';
        selectedCondiments.forEach((condiment,index) => {
            const condimentButton = document.createElement('button');
            condimentButton.textContent = condiment;
            condimentButton.onclick = () => removeCondiment(index);
            cartCondiments.appendChild(condimentButton);
        });
    }

    async function confirmOrder() {
        try {
            const order = {
                beverage: selectedBeverage,
                condiments: selectedCondiments
            };

            let response = await fetch(host + "/orders", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${configuration.token()}`
                },
                body: JSON.stringify(order),
            });
            if (response.ok) {
                const receipt = await response.json();
                const summary = `Order placed: Order id: ${receipt.id} ${selectedBeverage} with ${selectedCondiments.join(', ')}! Total: $${receipt.cost}`;
                document.getElementById('order-summary').textContent = summary;
                document.getElementById('page-condiments').style.display = 'none';
                document.getElementById('page-confirmation').style.display = 'block';
            }
            else {
                console.log(respose);
                throw new Error("Order wasn't placed.");
            }
        } catch(error) {
            if (response.status == 401) {
                logout();
            }
            console.error(error);
            throw new Error("Order didn't work");
        }
    }
</script>

</body>
</html>